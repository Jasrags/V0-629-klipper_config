# This file contains common pin mappings for the BIGTREETECH SKR
# MINI 2.0. To use this config, the firmware should be compiled for 
# the STM32F103 with a "28KiB bootloader". Also select "enable extra 
# low-level configuration options" and configure "GPIO pins to set 
# at micro-controller startup" to "!PA14".

# The "make flash" command does not work on the SKR mini. Instead,
# after running "make", copy the generated "out/klipper.bin" file to a
# file named "firmware.bin" on an SD card and then restart the SKR
# mini with that SD card.

# See the example.cfg file for a description of available parameters.

# [mcu]
# serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_33FFDB055356343531761543-if00

# [printer]
# kinematics: corexy
# max_velocity: 200
# max_accel: 2000
# max_z_velocity: 15
# max_z_accel: 45
# square_corner_velocity: 6.0

# [idle_timeout]
# timeout: 7200       # 2 hours

[include client.cfg]
[include client_macros.cfg]

[include configs/displays.cfg]
[include configs/extruder.cfg]
[include configs/fans.cfg]
[include configs/heaters.cfg]
[include configs/leds.cfg]
[include configs/macros.cfg]
[include configs/main_printer.cfg]
[include configs/probe.cfg]
[include configs/resonance.cfg]
[include configs/sample-glyphs.cfg]
[include configs/steppers.cfg]
[include configs/temperature.cfg]

# [gcode_macro PRINT_START]
# #   Use PRINT_START for the slicer starting script - please customize for your slicer of choice
# gcode:
#     G28                            ; home all axes
#     G1 Z20 F3000                   ; move nozzle away from bed
#     CASE_WHITE

# [gcode_macro PRINT_START]
# default_parameter_BED: 110      #target bed temperature
# default_parameter_EXTRUDER: 240 #target extruder temperature
# gcode:
#     SAVE_GCODE_STATE NAME=start

#     M117 Starting warmup
#     CASE_WHITE
#     G1 Z20 F3000                       ; move nozzle away from bed
#     M117 Warmup
#     M190 S{BED}                        ; set bed temp and wait for it reach temp
#     M109 S{EXTRUDER|int}               ; M109 heat and wait for it to reach temp

#     G1 Z5 F5000                        ; move head 5mm from bed surface
#     M83                                ; Make the E relative independant of other axis
#     G1 E9 F500 # unretract
#     M117 Starting Print
#     RESTORE_GCODE_STATE NAME=start
   
# [gcode_macro PRINT_END]
# #   Use PRINT_END for the slicer ending script - please customize for your slicer of choice
# gcode:
#     M400                           ; wait for buffer to clear
#     G92 E0                         ; zero the extruder
#     G1 E-10.0 F500                 ; retract filament
#     G91                            ; relative positioning

#     #   Get Boundaries
#     {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
#     {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
#     {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

#     #   Check end position to determine safe direction to move
#     {% if printer.toolhead.position.x < (max_x - 20) %}
#         {% set x_safe = 20.0 %}
#     {% else %}
#         {% set x_safe = -20.0 %}
#     {% endif %}

#     {% if printer.toolhead.position.y < (max_y - 20) %}
#         {% set y_safe = 20.0 %}
#     {% else %}
#         {% set y_safe = -20.0 %}
#     {% endif %}

#     {% if printer.toolhead.position.z < (max_z - 2) %}
#         {% set z_safe = 2.0 %}
#     {% else %}
#         {% set z_safe = max_z - printer.toolhead.position.z %}
#     {% endif %}

#     G0 Z{z_safe} F3600             ; move nozzle up
#     G0 X{x_safe} Y{y_safe} F20000  ; move nozzle to remove stringing
#     TURN_OFF_HEATERS
#     M107                           ; turn off fan
#     G90                            ; absolute positioning
#     G0 X60 Y{max_y} F3600          ; park nozzle at rear
#     CASE_PURPLE
#     M117 Print Complete

# [gcode_macro M600]
# gcode:
#     PAUSE
    
# [gcode_macro PAUSE]
# rename_existing: BASE_PAUSE
# default_parameter_X: 110    # edit to your preferred park position
# default_parameter_Y: 110    # edit to your preferred park position
# default_parameter_Z: 10     # edit to your preferred park position
# default_parameter_E: 4      # edit to your preferred retract length
# gcode:
#     SAVE_GCODE_STATE NAME=PAUSE_state
#     BASE_PAUSE
#     G91
#     G1 E-{E} F2100
#     G1 Z{Z}
#     G90
#     G1 X{X} Y{Y} F6000
    
# [gcode_macro RESUME]
# rename_existing: BASE_RESUME
# default_parameter_E: 4      # edit to your preferred retract length
# gcode:
#     G91
#     G1 E{E} F2100
#     G90
#     RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
#     BASE_RESUME

# [gcode_macro CANCEL_PRINT]
# rename_existing: BASE_CANCEL_PRINT
# gcode:
#     TURN_OFF_HEATERS
#     CLEAR_PAUSE
#     SDCARD_RESET_FILE
#     BASE_CANCEL_PRINT
#     CASE_PURPLE

# [gcode_macro LOAD_FILAMENT]
# gcode:
#    M83                            ; set extruder to relative
#    G1 E40 F300                    ; load
#    G1 E15 F150                    ; prime nozzle with filament
#    M82                            ; set extruder to absolute
    
# [gcode_macro UNLOAD_FILAMENT]
# gcode:
#    M83                            ; set extruder to relative
#    G1 E10 F300                    ; extrude a little to soften tip
#    G1 E-70 F500                  ; retract some, but not too much or it will jam
#    M82                            ; set extruder to absolute


# Sensor Types
#   "EPCOS 100K B57560G104F"
#   "ATC Semitec 104GT-2"
#   "NTC 100K beta 3950" (Keenovo Heater Pad)
#   "Honeywell 100K 135-104LAG-J01"
#   "NTC 100K MGB18-104F39050L32"
#   "AD595"
#   "PT100 INA826"

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 67.392
#*# pid_ki = 2.917
#*# pid_kd = 389.188
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 28.843
#*# pid_ki = 1.982
#*# pid_kd = 104.916
#*#
#*# [stepper_z]
#*# position_endstop = -0.100
